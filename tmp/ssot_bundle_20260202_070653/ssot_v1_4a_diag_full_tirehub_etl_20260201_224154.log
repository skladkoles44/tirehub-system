=== SSOT v1.4a FULL DIAG ===
TS=20260201_224154
PWD=/home/etl/apps/tirehub
DB=tirehub_etl

Pager usage is off.
                                                                version                                                                 
----------------------------------------------------------------------------------------------------------------------------------------
 PostgreSQL 16.11 (Ubuntu 16.11-0ubuntu0.24.04.1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0, 64-bit
(1 row)

   kind   |     proname     |                           ident_args                            
----------+-----------------+-----------------------------------------------------------------
 API_FUNC | publish_curated | p_snapshot_id uuid, p_curated_version text, p_published_by text
(1 row)

 kind | proname | ident_args 
------+---------+------------
(0 rows)

 kind  |                  name                   
-------+-----------------------------------------
 TABLE | ssot_curated_internal.artifact_pointers
 TABLE | ssot_curated_internal.curated_artifacts
 TABLE | ssot_curated_internal.offers_v1
 TABLE | ssot_ingestion.canonical_items_source
 TABLE | ssot_ingestion.canonical_snapshots
 TABLE | ssot_ingestion.warehouse_aliases
 TABLE | ssot_ingestion.warehouse_keys
(7 rows)

                                                  Table "ssot_ingestion.canonical_snapshots"
       Column       |            Type             | Collation | Nullable |   Default    | Storage  | Compression | Stats target | Description 
--------------------+-----------------------------+-----------+----------+--------------+----------+-------------+--------------+-------------
 snapshot_id        | uuid                        |           | not null |              | plain    |             |              | 
 ruleset_versions   | jsonb                       |           | not null |              | extended |             |              | 
 decomposer_version | text                        |           | not null |              | extended |             |              | 
 created_at         | timestamp without time zone |           | not null | now()        | plain    |             |              | 
 status             | text                        |           | not null | 'open'::text | extended |             |              | 
 sealed_at          | timestamp with time zone    |           |          |              | plain    |             |              | 
Indexes:
    "canonical_snapshots_pkey" PRIMARY KEY, btree (snapshot_id)
Check constraints:
    "canonical_snapshots_status_chk" CHECK (status = ANY (ARRAY['open'::text, 'sealed'::text]))
Referenced by:
    TABLE "ssot_ingestion.canonical_items_source" CONSTRAINT "canonical_items_source_snapshot_id_fkey" FOREIGN KEY (snapshot_id) REFERENCES ssot_ingestion.canonical_snapshots(snapshot_id)
Access method: heap

                                  Table "ssot_ingestion.canonical_items_source"
    Column     | Type  | Collation | Nullable |   Default   | Storage  | Compression | Stats target | Description 
---------------+-------+-----------+----------+-------------+----------+-------------+--------------+-------------
 id            | uuid  |           | not null |             | plain    |             |              | 
 snapshot_id   | uuid  |           | not null |             | plain    |             |              | 
 supplier_id   | text  |           | not null |             | extended |             |              | 
 raw           | jsonb |           | not null |             | extended |             |              | 
 quality_flags | jsonb |           |          | '[]'::jsonb | extended |             |              | 
Indexes:
    "canonical_items_source_pkey" PRIMARY KEY, btree (id)
Foreign-key constraints:
    "canonical_items_source_snapshot_id_fkey" FOREIGN KEY (snapshot_id) REFERENCES ssot_ingestion.canonical_snapshots(snapshot_id)
Referenced by:
    TABLE "ssot_curated_internal.offers_v1" CONSTRAINT "fk_offers_v1_canonical_item" FOREIGN KEY (canonical_item_id) REFERENCES ssot_ingestion.canonical_items_source(id)
Access method: heap

                                               Table "ssot_ingestion.warehouse_keys"
    Column     |            Type             | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
---------------+-----------------------------+-----------+----------+---------+----------+-------------+--------------+-------------
 warehouse_key | text                        |           | not null |         | extended |             |              | 
 display_name  | text                        |           | not null |         | extended |             |              | 
 is_active     | boolean                     |           |          | true    | plain    |             |              | 
 created_at    | timestamp without time zone |           |          | now()   | plain    |             |              | 
Indexes:
    "warehouse_keys_pkey" PRIMARY KEY, btree (warehouse_key)
Referenced by:
    TABLE "ssot_ingestion.warehouse_aliases" CONSTRAINT "warehouse_aliases_warehouse_key_fkey" FOREIGN KEY (warehouse_key) REFERENCES ssot_ingestion.warehouse_keys(warehouse_key)
Access method: heap

                                                   Table "ssot_ingestion.warehouse_aliases"
         Column          |            Type             | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
-------------------------+-----------------------------+-----------+----------+---------+----------+-------------+--------------+-------------
 supplier_id             | text                        |           | not null |         | extended |             |              | 
 supplier_warehouse_name | text                        |           | not null |         | extended |             |              | 
 warehouse_key           | text                        |           | not null |         | extended |             |              | 
 first_seen_at           | timestamp without time zone |           |          | now()   | plain    |             |              | 
 last_seen_at            | timestamp without time zone |           |          |         | plain    |             |              | 
Indexes:
    "warehouse_aliases_pkey" PRIMARY KEY, btree (supplier_id, supplier_warehouse_name)
Foreign-key constraints:
    "warehouse_aliases_warehouse_key_fkey" FOREIGN KEY (warehouse_key) REFERENCES ssot_ingestion.warehouse_keys(warehouse_key)
Access method: heap

                                                  Table "ssot_curated_internal.curated_artifacts"
         Column         |            Type             | Collation | Nullable |    Default     | Storage  | Compression | Stats target | Description 
------------------------+-----------------------------+-----------+----------+----------------+----------+-------------+--------------+-------------
 artifact_id            | uuid                        |           | not null |                | plain    |             |              | 
 snapshot_id            | uuid                        |           | not null |                | plain    |             |              | 
 curated_version        | text                        |           | not null |                | extended |             |              | 
 fingerprint            | bytea                       |           | not null |                | extended |             |              | 
 fingerprint_input      | jsonb                       |           | not null |                | extended |             |              | 
 checksum               | bytea                       |           |          |                | extended |             |              | 
 published_at           | timestamp without time zone |           | not null | now()          | plain    |             |              | 
 published_by           | text                        |           | not null |                | extended |             |              | 
 status                 | text                        |           |          | 'active'::text | extended |             |              | 
 generation_fingerprint | bytea                       |           |          |                | extended |             |              | 
 generated_at           | timestamp with time zone    |           |          |                | plain    |             |              | 
 status_v14a            | text                        |           |          |                | extended |             |              | 
Indexes:
    "curated_artifacts_pkey" PRIMARY KEY, btree (artifact_id)
    "curated_artifacts_fingerprint_key" UNIQUE CONSTRAINT, btree (fingerprint)
    "uq_curated_snapshot_version" UNIQUE, btree (snapshot_id, curated_version)
Check constraints:
    "curated_artifacts_status_chk" CHECK (status_v14a = ANY (ARRAY['generated'::text, 'published'::text, 'archived'::text]))
Referenced by:
    TABLE "ssot_curated_internal.artifact_pointers" CONSTRAINT "artifact_pointers_artifact_id_fkey" FOREIGN KEY (artifact_id) REFERENCES ssot_curated_internal.curated_artifacts(artifact_id)
    TABLE "ssot_curated_internal.offers_v1" CONSTRAINT "offers_v1_artifact_id_fkey" FOREIGN KEY (artifact_id) REFERENCES ssot_curated_internal.curated_artifacts(artifact_id)
Access method: heap

                                        Table "ssot_curated_internal.offers_v1"
      Column       |  Type   | Collation | Nullable |   Default   | Storage  | Compression | Stats target | Description 
-------------------+---------+-----------+----------+-------------+----------+-------------+--------------+-------------
 artifact_id       | uuid    |           | not null |             | plain    |             |              | 
 offer_id          | uuid    |           | not null |             | plain    |             |              | 
 canonical_item_id | uuid    |           | not null |             | plain    |             |              | 
 supplier_id       | text    |           | not null |             | extended |             |              | 
 warehouse_key     | text    |           | not null |             | extended |             |              | 
 price             | numeric |           |          |             | main     |             |              | 
 qty               | integer |           |          |             | plain    |             |              | 
 currency          | text    |           |          |             | extended |             |              | 
 quality_flags     | jsonb   |           |          | '[]'::jsonb | extended |             |              | 
 sku_candidate_key | text    |           | not null |             | extended |             |              | 
Indexes:
    "offers_v1_pkey" PRIMARY KEY, btree (artifact_id, offer_id)
    "idx_offers_v1_artifact_sku" btree (artifact_id, sku_candidate_key)
Foreign-key constraints:
    "fk_offers_v1_canonical_item" FOREIGN KEY (canonical_item_id) REFERENCES ssot_ingestion.canonical_items_source(id)
    "offers_v1_artifact_id_fkey" FOREIGN KEY (artifact_id) REFERENCES ssot_curated_internal.curated_artifacts(artifact_id)
Access method: heap

                                         Table "ssot_curated_internal.artifact_pointers"
   Column    |            Type             | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
-------------+-----------------------------+-----------+----------+---------+----------+-------------+--------------+-------------
 environment | text                        |           | not null |         | extended |             |              | 
 channel     | text                        |           | not null |         | extended |             |              | 
 artifact_id | uuid                        |           | not null |         | plain    |             |              | 
 valid_from  | timestamp without time zone |           | not null |         | plain    |             |              | 
 valid_to    | timestamp without time zone |           |          |         | plain    |             |              | 
 reason      | text                        |           |          |         | extended |             |              | 
Indexes:
    "artifact_pointers_pkey" PRIMARY KEY, btree (environment, channel, valid_from)
    "idx_pointers_env_channel_time" btree (environment, channel, valid_from DESC)
Foreign-key constraints:
    "artifact_pointers_artifact_id_fkey" FOREIGN KEY (artifact_id) REFERENCES ssot_curated_internal.curated_artifacts(artifact_id)
Access method: heap

 kind  |          obj           | count 
-------+------------------------+-------
 COUNT | artifact_pointers      |     1
 COUNT | canonical_items_source |     1
 COUNT | canonical_snapshots    |     1
 COUNT | curated_artifacts      |     1
 COUNT | offers_v1              |     1
 COUNT | warehouse_aliases      |     0
 COUNT | warehouse_keys         |     0
(7 rows)

      kind       | status | count 
-----------------+--------+-------
 SNAPSHOT_STATUS | sealed |     1
(1 row)

      kind       | status | count 
-----------------+--------+-------
 ARTIFACT_STATUS | active |     1
(1 row)

 kind  |                  tbl                  |          indexname          |                                                        indexdef                                                         
-------+---------------------------------------+-----------------------------+-------------------------------------------------------------------------------------------------------------------------
 INDEX | ssot_curated_internal.offers_v1       | idx_offers_v1_artifact_sku  | CREATE INDEX idx_offers_v1_artifact_sku ON ssot_curated_internal.offers_v1 USING btree (artifact_id, sku_candidate_key)
 INDEX | ssot_curated_internal.offers_v1       | offers_v1_pkey              | CREATE UNIQUE INDEX offers_v1_pkey ON ssot_curated_internal.offers_v1 USING btree (artifact_id, offer_id)
 INDEX | ssot_ingestion.canonical_items_source | canonical_items_source_pkey | CREATE UNIQUE INDEX canonical_items_source_pkey ON ssot_ingestion.canonical_items_source USING btree (id)
(3 rows)

    kind     |             artifact_id              
-------------+--------------------------------------
 CURRENT_PTR | 5df74ef5-b015-4798-a339-c0115d09129a
(1 row)

